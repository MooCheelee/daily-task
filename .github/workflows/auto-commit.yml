name: Daily GitHub Activity

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹è§¦å‘
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      # æ‹‰å–ä»“åº“
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      # æ¨¡æ‹Ÿæ‹Ÿäººä½œæ¯ + éšæœºå»¶è¿Ÿ
      - name: Human-like delay
        run: |
          HOUR=$(date +%H)
          # ç™½å¤© (8-22ç‚¹) å»¶è¿ŸçŸ­ï¼Œå¤œé‡Œå»¶è¿Ÿé•¿
          if [ $HOUR -ge 8 ] && [ $HOUR -le 22 ]; then
            DELAY=$((RANDOM % 1))   # æœ€å¤šå»¶è¿Ÿ 4 å°æ—¶
          else
            DELAY=$((RANDOM % 2))   # æœ€å¤šå»¶è¿Ÿ 8 å°æ—¶
          fi
          echo "æ¨¡æ‹Ÿäººç±»ä½œæ¯ï¼Œç­‰å¾… $DELAY ç§’å†æ‰§è¡Œ..."
          sleep $DELAY

          # å‘¨æœ«æ‡’æƒ°æ¨¡å¼
          DOW=$(date +%u)
          if [ $DOW -gt 5 ]; then
            RAND=$((RANDOM % 100))
            if [ $RAND -lt 40 ]; then
              echo "## $(date '+%Y-%m-%d')" >> update.md
              echo "ğŸ›‹ï¸ å‘¨æœ«èººå¹³ä¸€å¤©ï¼Œå•¥ä¹Ÿæ²¡å¹²ã€‚" >> update.md
              exit 0
            fi
          fi

      # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
      - name: Ensure update.md exists
        run: |
          if [ ! -f update.md ]; then
            echo "# Daily Commit Log" > update.md
          fi

      # å¼€åœºç™½
      - name: Write opening log
        run: |
          echo "## $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" >> update.md
          OPENINGS=("ğŸŒ æ—©å®‰ï¼Œä»Šå¤©ä¹Ÿæ¥ GitHub æ‰“ä¸ªå¡ï¼"
                    "ğŸ“… æ–°çš„ä¸€å¤©ï¼Œåˆæ˜¯æ´»è·ƒçš„ä¸€å¤©ã€‚"
                    "ğŸ‘‹ æ‰“ä¸ªæ‹›å‘¼ï¼šå¤§å®¶å¥½ï¼Œæˆ‘æ¥å•¦~"
                    "âœ¨ å¼€å§‹ä»Šå¤©çš„ Github å†’é™©ï¼")
          echo "${OPENINGS[$RANDOM % ${#OPENINGS[@]}]}" >> update.md

      # æ¸…ç† 7 å¤©å‰æ—¥å¿—
      - name: Clean up logs older than 7 days
        run: |
          find . -name "update.md" -mtime +7 -exec rm -f {} \; || true
          echo "ğŸ§¹ æ¸…ç†äº† 7 å¤©å‰çš„æ—¥å¿—" >> update.md

      # æ¯æ—¥æäº¤
      - name: Append daily log
        run: |
          LOGS=("ğŸŒ± éšæ‰‹è®°ä¸‹ä¸€ç¬”"
                "ğŸ“ ç•™ä¸ªå°è„šå°"
                "ğŸ“Œ æ‰“å¡ä¸€ä¸‹"
                "ğŸ”– è®°å½•ä»Šå¤©çš„ç‚¹æ»´")
          MSG=${LOGS[$RANDOM % ${#LOGS[@]}]}
          echo "[$(TZ='Asia/Shanghai' date '+%H:%M:%S')] $MSG" >> update.md

      - name: Commit and push log
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add update.md
          git commit -m "chore: daily log update" || echo "No changes to commit"
          git push origin main

      # éšæœºåˆ›å»º Issue
      - name: Randomly create Issue
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 100 ]; then
            BODY=("ğŸŒ± éšæ‰‹å¼€äº†ä¸ª Issue"
                  "âœï¸ çªç„¶æƒ³åˆ°ç‚¹ä¸œè¥¿ï¼Œè®°å½•ä¸€ä¸‹"
                  "ğŸ’¡ çµæ„Ÿæ¥äº†ï¼Œæ–°å»ºä¸ª Issue"
                  "ğŸ¤” å°é—®é¢˜ï¼Œå†™ä¸‹æ¥çœ‹çœ‹")
            MSG=${BODY[$RANDOM % ${#BODY[@]}]}
            echo "[$(date '+%H:%M:%S')] $MSG" >> update.md
            gh issue create --title "Daily Issue - $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" \
                            --body "$MSG" \
                            --repo $GITHUB_REPOSITORY
          fi

      # éšæœºåˆ›å»º PR
      - name: Randomly create PR
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 100 ]; then
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b $BRANCH
            echo "[$(date '+%H:%M:%S')] ğŸš€ æ¥ä¸€å‘ PR" >> update.md
            git add update.md
            git commit -m "chore: daily PR update"
            git push origin $BRANCH
            gh pr create --title "Daily PR - $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" \
                         --body "è‡ªåŠ¨ç”Ÿæˆçš„ PRï¼Œè®°å½•ä¸€ä¸‹ âœ¨" \
                         --base main \
                         --head $BRANCH \
                         --repo $GITHUB_REPOSITORY
          fi

      # è‡ªåŠ¨ Review + åˆå¹¶
      - name: Auto Review and Merge PR
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TARGET_REPO="${GITHUB_REPOSITORY}"
          PR_LIST=$(gh pr list --state open --repo "$TARGET_REPO" --json number -q '.[].number')
          if [ -n "$PR_LIST" ]; then
            PR_NUM=$(echo "$PR_LIST" | shuf -n1)
            gh pr review "$PR_NUM" --comment --body "ğŸ¤– è‡ªåŠ¨å®¡æŸ¥ä¸€ä¸‹ï¼Œçœ‹èµ·æ¥æŒºä¸é”™ï¼"
            gh pr merge "$PR_NUM" --squash --delete-branch --repo "$TARGET_REPO" --admin
            echo "[$(date '+%H:%M:%S')] âœ… åˆå¹¶äº†è‡ªå·±çš„ PR #$PR_NUM" >> update.md
          fi

      # éšæœº star ä»“åº“
      - name: Randomly star repos
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPOS=("vercel/next.js" "facebook/react" "microsoft/vscode" "torvalds/linux" "twbs/bootstrap")
          COUNT=$((1 + RANDOM % 2)) # 1~2 ä¸ª
          for i in $(seq 1 $COUNT); do
            REPO=${REPOS[$RANDOM % ${#REPOS[@]}]}
            gh api user/starred/$REPO -X PUT
            echo "[$(date '+%H:%M:%S')] â­ è·¯è¿‡ç‚¹äº†ä¸ª Star: $REPO" >> update.md
          done

      # æ¸…ç†æ—§åˆ†æ”¯
      - name: Clean up old merged branches
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TARGET_REPO="${GITHUB_REPOSITORY}"
          for branch in $(gh api repos/$TARGET_REPO/branches --paginate --jq '.[].name' | grep '^daily-pr-'); do
            if git branch -r --contains origin/$branch | grep -q "origin/main"; then
              LAST_COMMIT=$(gh api repos/$TARGET_REPO/commits/$branch --jq '.commit.committer.date')
              LAST_COMMIT_TS=$(date -d "$LAST_COMMIT" +%s)
              NOW=$(date +%s)
              AGE=$(( (NOW - LAST_COMMIT_TS) / 86400 ))
              if [ $AGE -gt 7 ]; then
                git push origin --delete $branch || true
                echo "[$(date '+%H:%M:%S')] ğŸ§¹ åˆ é™¤æ—§åˆ†æ”¯: $branch" >> update.md
              fi
            fi
          done

      # æ”¶å°¾æ€»ç»“
      - name: Write summary log
        run: |
          ENDINGS=("ğŸŒ™ ä»Šæ—¥å°ç»“ï¼šå¹³å¹³æ— å¥‡ä½†åšæŒæ‰“å¡ã€‚"
                   "ğŸ“– ä¸€å¤©ç»“æŸï¼Œç•™ä¸‹ä¸€ç‚¹è®°å½•ã€‚"
                   "ğŸŒŸ ä»Šå¤©ä¹Ÿç®—å……å®ã€‚"
                   "ğŸ˜´ è¯¥ä¼‘æ¯å•¦ï¼Œæ˜å¤©è§ã€‚")
          echo "${ENDINGS[$RANDOM % ${#ENDINGS[@]}]}" >> update.md
