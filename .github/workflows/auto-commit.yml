name: Daily Random GitHub Activity & Mutual Review

on:
  schedule:
    - cron: '0 0 * * *'  # ÊØèÂ§© UTC 0 ÁÇπ
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      ACTOR_A: ${{ github.actor }}
      TOKEN_A: ${{ secrets.GH_TOKEN }}    # Ë¥¶Âè∑ A ÁöÑ token
      TOKEN_B: ${{ secrets.PAT_B }}       # Ë¥¶Âè∑ B ÁöÑ PATÔºåÁî®‰∫éËá™Âä® approve

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Ensure update.md exists
        run: |
          if [ ! -f update.md ]; then
            echo "# Daily Activity Log" > update.md
            echo "" >> update.md
          fi

      - name: Determine Random Execution Count
        id: exec_count
        run: |
          EXEC_COUNT=$((1 + RANDOM % 2))
          echo "execution_count=$EXEC_COUNT" >> $GITHUB_OUTPUT

      - name: Run Random Actions (commit / Issue / PR)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          ISSUE_BODIES=("ÈöèÊú∫ÁîüÊàêÊØèÊó• Issue üå±" "Ëá™Âä®ËÆ∞ÂΩïÊØèÊó•Ê¥ªË∑É ‚ú®" "‰ªäÊó•Êó•Âøó Issue üê£" "Â∞èÂ∞èÊèêÈÜíÔºö‰øùÊåÅÊ¥ªË∑É üí°" "ÊØèÊó•Á¨îËÆ∞Êó•Âøó üìù")
          PR_BODIES=("ÈöèÊú∫ÁîüÊàêÊØèÊó• PR üå±" "ÊØèÊó•Êõ¥Êñ∞ËÆ∞ÂΩï ‚ú®" "Ëá™Âä®ÁîüÊàê PR üê£" "‰ªäÊó•Â∑•‰ΩúÂø´ÁÖß üì∏" "Â∞èÊîπÂä® PR ‚úèÔ∏è")
          PR_LOGS=("Ëá™Âä® PR Êó•Âøó üå±" "ÊØèÊó•Êõ¥Êñ∞ËÆ∞ÂΩï ‚ú®" "ÈöèÊú∫ÁîüÊàê PR üê£" "Â∞èÂ∞èÊèê‰∫§ üå∏" "‰ªäÊó•ËøõÂ∫¶ üèÉ‚Äç‚ôÇÔ∏è")
          COMMIT_MESSAGES=("Êõ¥Êñ∞ÊñáÊ°£ ‚úèÔ∏è" "‰øÆÂ§çÂ∞è bug üêõ" "Ê∑ªÂä†ÊµãËØï ‚úÖ" "‰ºòÂåñÊó•ÂøóËæìÂá∫ üìú" "Â∞è‰øÆÊîπ üåü")
          EMOJIS=("üå±" "‚ú®" "üê£" "üí°" "üìú" "üì∏" "üå∏" "üèÉ‚Äç‚ôÇÔ∏è" "üêõ" "üåü")
          TAGS=("#note" "#daily" "#update" "#bugfix" "#‚ú®" "#log" "#code" "#review")
          RANDOM_WORDS=("sun" "moon" "star" "tree" "flower" "code" "log" "note" "spark" "leaf")

          for i in $(seq 1 ${{ steps.exec_count.outputs.execution_count }}); do
            SLEEP_MIN=$((RANDOM % 1))
            echo "Execution $i: sleeping $SLEEP_MIN minutes..."
            sleep "${SLEEP_MIN}m"

            TIME_STR=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

            EMO_COUNT=$((1 + RANDOM % 3))
            LINE_EMOJIS=""
            for e in $(seq 1 $EMO_COUNT); do
              LINE_EMOJIS="$LINE_EMOJIS ${EMOJIS[$RANDOM % ${#EMOJIS[@]}]}"
            done
            TAG_COUNT=$((1 + RANDOM % 2))
            LINE_TAGS=""
            for t in $(seq 1 $TAG_COUNT); do
              LINE_TAGS="$LINE_TAGS ${TAGS[$RANDOM % ${#TAGS[@]}]}"
            done

            echo "## $TIME_STR - Run $i $LINE_EMOJIS $LINE_TAGS" >> update.md
            echo "- üìù Commit: Êõ¥Êñ∞Êó•Âøó $LINE_EMOJIS $LINE_TAGS" >> update.md

            COMMIT_COUNT=$((1 + RANDOM % 3))
            for j in $(seq 1 $COMMIT_COUNT); do
              LINE="ÈöèÊú∫Êó•ÂøóÂÜÖÂÆπ $RANDOM $LINE_EMOJIS $LINE_TAGS"
              echo "$LINE" >> update.md
              git add update.md
              git commit -m "${COMMIT_MESSAGES[$RANDOM % ${#COMMIT_MESSAGES[@]}]}" || echo "No changes"
            done

            # ÈöèÊú∫ Issue
            RAND=$((RANDOM % 100))
            if [ $RAND -lt 100 ]; then
              TODAY=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
              ISSUE_TITLE="Daily Issue - $TODAY"
              ISSUE_NUMBER=$(gh issue list --repo $REPO --state open --search "$ISSUE_TITLE in:title" --json number --jq '.[0].number')
              if [ -z "$ISSUE_NUMBER" ]; then
                BODY="${ISSUE_BODIES[$RANDOM % ${#ISSUE_BODIES[@]}]}"
                gh issue create --title "$ISSUE_TITLE" --body "$BODY" --repo $REPO
                echo "- üÜï Issue: Â∑≤ÂàõÂª∫ $ISSUE_TITLE" >> update.md
              else
                gh issue comment $ISSUE_NUMBER --body "ü§ñ Ëá™Âä®ËØÑËÆ∫ÔºöÊØèÊó•Ê¥ªË∑ÉËÆ∞ÂΩï ‚ú®"
                echo "- üí¨ Issue: Â∑≤ËØÑËÆ∫ #$ISSUE_NUMBER" >> update.md
              fi
            else
              echo "- üÜï Issue: Êú™ÊâßË°å" >> update.md
            fi

            # ÈöèÊú∫ PR
            RAND=$((RANDOM % 100))
            if [ $RAND -lt 100 ]; then
              RAND_WORD=${RANDOM_WORDS[$RANDOM % ${#RANDOM_WORDS[@]}]}
              BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')-$RAND_WORD"
              git checkout -b $BRANCH
              LOG="${PR_LOGS[$RANDOM % ${#PR_LOGS[@]}]}"
              echo "$TIME_STR - $LOG" >> update.md
              git add update.md
              git commit -m "${COMMIT_MESSAGES[$RANDOM % ${#COMMIT_MESSAGES[@]}]}"
              git push origin $BRANCH --set-upstream
              BODY="${PR_BODIES[$RANDOM % ${#PR_BODIES[@]}]}"
              gh pr create --title "Daily PR - $TIME_STR" --body "$BODY" --base main --head $BRANCH --repo $REPO
              echo "- üîÄ PR: Â∑≤ÂàõÂª∫ $BRANCH" >> update.md
            else
              echo "- üîÄ PR: Êú™ÊâßË°å" >> update.md
            fi
          done

      - name: Clean Old Logs
        run: |
          tail -n 14 update.md > update_tmp.md
          mv update_tmp.md update.md

      - name: Commit and Push Final Update Safely
        run: |
          git add update.md
          git commit -m "chore: finalize daily log" || echo "No changes"
          git pull --rebase --autostash origin main
          git push origin HEAD:main

      - name: Auto Approve PRs using B
        run: |
          echo "Fetching open PRs not by B..."
          PR_LIST=$(GH_TOKEN=${{ secrets.PAT_B }} gh pr list --state open --repo $REPO --json number,author \
                    --jq ".[] | select(.author.login != \"MooChee-lee\") | .number")

          for PR in $PR_LIST; do
            echo "Approving PR #$PR with B..."
            GH_TOKEN=${{ secrets.PAT_B }} gh pr review $PR --approve --body "üëç Ëá™Âä®‰∫íÁõ∏ Code Review" --repo $REPO
          done
