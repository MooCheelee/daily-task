name: Daily Random GitHub Activity

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹è§¦å‘ï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼‰
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      # æ‹‰å–ä»“åº“
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}

      # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # ç¡®ä¿ update.md æ–‡ä»¶å­˜åœ¨
      - name: Ensure update.md exists
        run: |
          if [ ! -f update.md ]; then
            echo "# Daily Activity Log" > update.md
            echo "" >> update.md
          fi

      # è¿½åŠ æ—¥å¿—ï¼ˆæ¯æ—¥å¿…å®šæœ‰ Commitï¼‰
      - name: Append daily log
        run: |
          echo "## $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> update.md
          echo "- ğŸ“ Commit: æ›´æ–°æ—¥å¿—" >> update.md

      # æäº¤æ—¥å¿—
      - name: Commit and push log
        run: |
          git add update.md
          git commit -m "chore: daily log update" || echo "No changes to commit"
          git push origin HEAD:main

      # éšæœºåˆ›å»ºæˆ–è¯„è®º Issue (30%)
      - name: Random Daily Issue or Comment
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 100 ]; then
            TODAY=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
            ISSUE_TITLE="Daily Issue - $TODAY"

            ISSUE_NUMBER=$(gh issue list --repo $GITHUB_REPOSITORY --state open --search "$ISSUE_TITLE in:title" --json number --jq '.[0].number')

            if [ -z "$ISSUE_NUMBER" ]; then
              gh issue create --title "$ISSUE_TITLE" \
                              --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ğŸŒ±" \
                              --repo $GITHUB_REPOSITORY
              echo "- ğŸ†• Issue: å·²åˆ›å»º $ISSUE_TITLE" >> update.md
            else
              gh issue comment $ISSUE_NUMBER --body "ğŸ¤– è‡ªåŠ¨è¯„è®ºï¼šæ¯æ—¥æ´»è·ƒè®°å½• âœ¨"
              echo "- ğŸ’¬ Issue: å·²è¯„è®º #$ISSUE_NUMBER" >> update.md
            fi
          else
            echo "- ğŸ†• Issue: æœªæ‰§è¡Œ" >> update.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      # éšæœºåˆ›å»ºæ¯æ—¥ PR (30%)
      - name: Random Daily PR
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 100 ]; then
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b $BRANCH
            echo "$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨ PR æ—¥å¿— ğŸŒ±" >> update.md
            git add update.md
            git commit -m "chore: daily PR update"
            git push origin $BRANCH

            gh pr create --title "Daily PR - $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" \
                         --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ğŸŒ±" \
                         --base main \
                         --head $BRANCH \
                         --repo $GITHUB_REPOSITORY
            echo "- ğŸ”€ PR: å·²åˆ›å»º $BRANCH" >> update.md
          else
            echo "- ğŸ”€ PR: æœªæ‰§è¡Œ" >> update.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      # éšæœºç»™åˆ«äºº PR åš Code Review (30%)
      - name: Random Code Review
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 100 ]; then
            PR_INFO=$(gh pr list --state open --repo $GITHUB_REPOSITORY --json number,author --jq '.[] | select(.author.login != "${{ github.actor }}") | .number' | head -n 1)
            if [ -n "$PR_INFO" ]; then
              gh pr review $PR_INFO --approve --body "ğŸ‘ è‡ªåŠ¨å®¡æ ¸ï¼šä»£ç å¾ˆæ£’ï¼ç»§ç»­åŠ æ²¹ ğŸŒ±"
              echo "- âœ… Review: å·²å®¡æ ¸ PR #$PR_INFO" >> update.md
            else
              echo "- âœ… Review: æ²¡æœ‰å¯å®¡æ ¸çš„ PR" >> update.md
            fi
          else
            echo "- âœ… Review: æœªæ‰§è¡Œ" >> update.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      # æ¨é€æœ€ç»ˆæ›´æ–°æ—¥å¿—
      - name: Push final update
        run: |
          git add update.md
          git commit -m "chore: finalize daily log" || echo "No changes to commit"
          git push origin HEAD:main
