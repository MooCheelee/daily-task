name: Daily GitHub Activity

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹è§¦å‘
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Setup environment
        run: |
          sudo apt-get update -y >/dev/null 2>&1 || true
          sudo apt-get install -y jq >/dev/null 2>&1 || true

      - name: Run daily tasks
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail

          LOG_FILE="update.md"
          TARGET_REPO="${GITHUB_REPOSITORY}"

          # ========== å‘¨æœ«æ‘¸é±¼ ==========
          DOW=$(date +%u)  # 1=Mon ... 7=Sun
          if [ $DOW -gt 5 ]; then
            RAND=$((RANDOM % 100))
            if [ $RAND -lt 30 ]; then
              echo "ä»Šå¤©æ˜¯å‘¨æœ«ï¼Œé€‰æ‹©æ‘¸é±¼ âœ¨" >> $LOG_FILE
              exit 0
            fi
          fi

          # ========== ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨ ==========
          if [ ! -f "$LOG_FILE" ]; then
            echo "# Daily Commit Log" > "$LOG_FILE"
          fi

          # ========== æ¸…ç†æ—§æ—¥å¿—ï¼ˆ15 å¤©å‰ï¼‰ ==========
          NOW=$(date +%s)
          TMP_FILE=$(mktemp)
          while IFS= read -r line; do
            if [[ $line =~ ^\[([0-9-]{10}\ [0-9:]{8})\] ]]; then
              TS=$(date -d "${BASH_REMATCH[1]}" +%s || true)
              AGE=$(( (NOW - TS) / 86400 ))
              if [ $AGE -le 15 ]; then
                echo "$line" >> "$TMP_FILE"
              fi
            else
              echo "$line" >> "$TMP_FILE"
            fi
          done < "$LOG_FILE"
          mv "$TMP_FILE" "$LOG_FILE"

          # ========== éšæœºæ‰§è¡Œæ¬¡æ•° ==========
          COUNT=$(( (RANDOM % 7) + 2 ))
          echo "ä»Šå¤©æ‰§è¡Œ $COUNT æ¬¡ä»»åŠ¡" | tee -a "$LOG_FILE"

          for ((i=1; i<=COUNT; i++)); do
            DELAY=$((RANDOM % 1800))  # æœ€å¤šå»¶è¿Ÿ 30 åˆ†é’Ÿ
            ACTION_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            echo "[$ACTION_TIME] ç¬¬ $i æ¬¡ä»»åŠ¡ï¼Œç­‰å¾… $DELAY ç§’..." | tee -a "$LOG_FILE"
            sleep $DELAY

            # ===== æäº¤æ—¥å¿— =====
            ACTION_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            echo "[$ACTION_TIME] ðŸ“ è‡ªåŠ¨æäº¤æ—¥å¿—" >> "$LOG_FILE"
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add "$LOG_FILE"
            git commit -m "chore: daily log update" || true
            git push origin main || true

            # ===== éšæœºåˆ›å»º Issue =====
            RAND=$((RANDOM % 10))
            if [ $RAND -lt 3 ]; then
              ACTION_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              ISSUE_URL=$(gh issue create \
                --title "Daily Issue - $(date '+%Y-%m-%d')" \
                --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ðŸŒ±" \
                --repo "$TARGET_REPO")
              echo "[$ACTION_TIME] ðŸž åˆ›å»º Issue: $ISSUE_URL" >> "$LOG_FILE"
            fi

            # ===== éšæœºåˆ›å»º PR =====
            RAND=$((RANDOM % 10))
            if [ $RAND -lt 3 ]; then
              BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
              git checkout -b "$BRANCH"
              git config user.name "github-actions[bot]"
              git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
              echo "[$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')] - è‡ªåŠ¨ PR æ—¥å¿— ðŸŒ±" >> "$LOG_FILE"
              git add "$LOG_FILE"
              git commit -m "chore: daily PR update"
              git push origin "$BRANCH"
              PR_URL=$(gh pr create \
                --title "Daily PR - $(date '+%Y-%m-%d')" \
                --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ðŸŒ±" \
                --base main \
                --head "$BRANCH" \
                --repo "$TARGET_REPO")
              ACTION_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              echo "[$ACTION_TIME] ðŸ”€ åˆ›å»º PR: $PR_URL" >> "$LOG_FILE"
            fi

            # ===== è‡ªåŠ¨ Review å¹¶åˆå¹¶ PR =====
            PR_LIST=$(gh pr list --state open --repo "$TARGET_REPO" --json number -q '.[].number')
            if [ -n "$PR_LIST" ]; then
              PR_NUM=$(echo "$PR_LIST" | shuf -n1)
              ACTION_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              echo "[$ACTION_TIME] ðŸ‘€ è‡ªåŠ¨å®¡æŸ¥ PR #$PR_NUM" >> "$LOG_FILE"
              gh pr review "$PR_NUM" --comment --body "ðŸ¤– è‡ªåŠ¨å®¡æŸ¥ï¼šLooks good!"
              gh pr merge "$PR_NUM" --squash --delete-branch --repo "$TARGET_REPO" || true
            fi

            # ===== æ¸…ç† old merged branches =====
            echo "å¼€å§‹æ¸…ç†å·²åˆå¹¶ 15 å¤©å‰çš„åˆ†æ”¯..."
            gh api "/repos/$TARGET_REPO/pulls?state=closed&per_page=100" \
            | jq -r '
                .[]
                | select(.merged_at != null)
                | select(.base.ref == "main")
                | select(.head.ref | startswith("daily-pr-"))
                | select((now - (.merged_at | fromdateiso8601)) / 86400 > 15)
                | .head.ref
              ' \
            | while read -r BRANCH; do
                [ -z "$BRANCH" ] && continue
                echo "ðŸ§¹ åˆ é™¤å·²åˆå¹¶å¹¶è¶…è¿‡ 15 å¤©çš„åˆ†æ”¯: $BRANCH"
                gh api --method DELETE "repos/$TARGET_REPO/git/refs/heads/$BRANCH" || true
                ACTION_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
                echo "[$ACTION_TIME] ðŸ—‘ åˆ é™¤åˆ†æ”¯: $BRANCH" >> "$LOG_FILE"
              done

            # ===== éšæœºåŠ  Star çƒ­é—¨ä»“åº“ =====
            REPOS=$(gh api 'search/repositories?q=stars:>5000&sort=stars&order=desc&per_page=10' --jq '.items[].full_name')
            COUNT_STAR=0
            for repo in $REPOS; do
              RAND=$((RANDOM % 100))
              if [ $RAND -lt 40 ]; then
                gh api --method PUT "user/starred/$repo"
                ACTION_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
                echo "[$ACTION_TIME] â­ ä¸ºä»“åº“åŠ æ˜Ÿ: $repo" >> "$LOG_FILE"
                COUNT_STAR=$((COUNT_STAR+1))
                if [ $COUNT_STAR -ge 3 ]; then
                  break
                fi
              fi
            done

          done
