name: Daily Random GitHub Activity & Mutual Review

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      ACTOR_A: ${{ github.actor }}
      TOKEN_A: ${{ secrets.GH_TOKEN }}    # workflow é»˜è®¤ token
      TOKEN_B: ${{ secrets.PAT_B }}       # è´¦å· B çš„ PATï¼Œç”¨äºè‡ªåŠ¨ approve

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Ensure update.md exists
        run: |
          if [ ! -f update.md ]; then
            echo "# Daily Activity Log" > update.md
            echo "" >> update.md
          fi

      - name: Determine Random Execution Count
        id: exec_count
        run: |
          EXEC_COUNT=$((1 + RANDOM % 2))
          echo "execution_count=$EXEC_COUNT" >> $GITHUB_OUTPUT

      - name: Run Random Actions (commit / Issue / PR)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}   # ç»™ gh å‘½ä»¤æˆæƒ
        run: |
          ISSUE_BODIES=("éšæœºç”Ÿæˆæ¯æ—¥ Issue ğŸŒ±" "è‡ªåŠ¨è®°å½•æ¯æ—¥æ´»è·ƒ âœ¨" "ä»Šæ—¥æ—¥å¿— Issue ğŸ£" "å°å°æé†’ï¼šä¿æŒæ´»è·ƒ ğŸ’¡" "æ¯æ—¥ç¬”è®°æ—¥å¿— ğŸ“")
          PR_BODIES=("éšæœºç”Ÿæˆæ¯æ—¥ PR ğŸŒ±" "æ¯æ—¥æ›´æ–°è®°å½• âœ¨" "è‡ªåŠ¨ç”Ÿæˆ PR ğŸ£" "ä»Šæ—¥å·¥ä½œå¿«ç…§ ğŸ“¸" "å°æ”¹åŠ¨ PR âœï¸")
          PR_LOGS=("è‡ªåŠ¨ PR æ—¥å¿— ğŸŒ±" "æ¯æ—¥æ›´æ–°è®°å½• âœ¨" "éšæœºç”Ÿæˆ PR ğŸ£" "å°å°æäº¤ ğŸŒ¸" "ä»Šæ—¥è¿›åº¦ ğŸƒâ€â™‚ï¸")
          COMMIT_MESSAGES=("æ›´æ–°æ–‡æ¡£ âœï¸" "ä¿®å¤å° bug ğŸ›" "æ·»åŠ æµ‹è¯• âœ…" "ä¼˜åŒ–æ—¥å¿—è¾“å‡º ğŸ“œ" "å°ä¿®æ”¹ ğŸŒŸ")
          EMOJIS=("ğŸŒ±" "âœ¨" "ğŸ£" "ğŸ’¡" "ğŸ“œ" "ğŸ“¸" "ğŸŒ¸" "ğŸƒâ€â™‚ï¸" "ğŸ›" "ğŸŒŸ")
          TAGS=("#note" "#daily" "#update" "#bugfix" "#âœ¨" "#log" "#code" "#review")
          RANDOM_WORDS=("sun" "moon" "star" "tree" "flower" "code" "log" "note" "spark" "leaf")

          for i in $(seq 1 ${{ steps.exec_count.outputs.execution_count }}); do
            # éšæœºå»¶è¿Ÿ
            SLEEP_MIN=$((RANDOM % 1))
            echo "Execution $i: sleeping $SLEEP_MIN minutes..."
            sleep "${SLEEP_MIN}m"

            TIME_STR=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

            # éšæœº emoji / æ ‡ç­¾
            EMO_COUNT=$((1 + RANDOM % 3))
            LINE_EMOJIS=""
            for e in $(seq 1 $EMO_COUNT); do
              LINE_EMOJIS="$LINE_EMOJIS ${EMOJIS[$RANDOM % ${#EMOJIS[@]}]}"
            done
            TAG_COUNT=$((1 + RANDOM % 2))
            LINE_TAGS=""
            for t in $(seq 1 $TAG_COUNT); do
              LINE_TAGS="$LINE_TAGS ${TAGS[$RANDOM % ${#TAGS[@]}]}"
            done

            echo "## $TIME_STR - Run $i $LINE_EMOJIS $LINE_TAGS" >> update.md
            echo "- ğŸ“ Commit: æ›´æ–°æ—¥å¿— $LINE_EMOJIS $LINE_TAGS" >> update.md

            # éšæœº commit
            COMMIT_COUNT=$((1 + RANDOM % 3))
            for j in $(seq 1 $COMMIT_COUNT); do
              LINE="éšæœºæ—¥å¿—å†…å®¹ $RANDOM $LINE_EMOJIS $LINE_TAGS"
              echo "$LINE" >> update.md
              git add update.md
              git commit -m "${COMMIT_MESSAGES[$RANDOM % ${#COMMIT_MESSAGES[@]}]}" || echo "No changes"
            done

            # éšæœº Issue
            RAND=$((RANDOM % 100))
            if [ $RAND -lt 100 ]; then
              TODAY=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
              ISSUE_TITLE="Daily Issue - $TODAY"
              ISSUE_NUMBER=$(gh issue list --repo $REPO --state open --search "$ISSUE_TITLE in:title" --json number --jq '.[0].number')
              if [ -z "$ISSUE_NUMBER" ]; then
                BODY="${ISSUE_BODIES[$RANDOM % ${#ISSUE_BODIES[@]}]}"
                gh issue create --title "$ISSUE_TITLE" --body "$BODY" --repo $REPO
                echo "- ğŸ†• Issue: å·²åˆ›å»º $ISSUE_TITLE" >> update.md
              else
                gh issue comment $ISSUE_NUMBER --body "ğŸ¤– è‡ªåŠ¨è¯„è®ºï¼šæ¯æ—¥æ´»è·ƒè®°å½• âœ¨"
                echo "- ğŸ’¬ Issue: å·²è¯„è®º #$ISSUE_NUMBER" >> update.md
              fi
            else
              echo "- ğŸ†• Issue: æœªæ‰§è¡Œ" >> update.md
            fi

            # éšæœº PR
            RAND=$((RANDOM % 100))
            if [ $RAND -lt 100 ]; then
              RAND_WORD=${RANDOM_WORDS[$RANDOM % ${#RANDOM_WORDS[@]}]}
              BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')-$RAND_WORD"
              git checkout -b $BRANCH
              LOG="${PR_LOGS[$RANDOM % ${#PR_LOGS[@]}]}"
              echo "$TIME_STR - $LOG" >> update.md
              git add update.md
              git commit -m "${COMMIT_MESSAGES[$RANDOM % ${#COMMIT_MESSAGES[@]}]}"
              git push origin $BRANCH --set-upstream
              BODY="${PR_BODIES[$RANDOM % ${#PR_BODIES[@]}]}"
              gh pr create --title "Daily PR - $TIME_STR" --body "$BODY" --base main --head $BRANCH --repo $REPO
              echo "- ğŸ”€ PR: å·²åˆ›å»º $BRANCH" >> update.md
            else
              echo "- ğŸ”€ PR: æœªæ‰§è¡Œ" >> update.md
            fi
          done

      - name: Clean Old Logs
        run: |
          tail -n 14 update.md > update_tmp.md
          mv update_tmp.md update.md

      - name: Commit and Push Final Update Safely
        run: |
          git add update.md
          git commit -m "chore: finalize daily log" || echo "No changes"
          git pull --rebase --autostash origin main
          git push origin HEAD:main

      - name: Auto Approve PRs using B
        env:
          GH_TOKEN: ${{ secrets.PAT_B }}  # ä½¿ç”¨è´¦å· B çš„ PAT
        run: |
          echo "Fetching open PRs not by B..."
          PR_LIST=$(gh pr list --state open --repo $REPO --json number,author \
                    --jq ".[] | select(.author.login != \"Bè´¦å·ç”¨æˆ·å\") | .number")
          for PR in $PR_LIST; do
            echo "Approving PR #$PR with B..."
            gh pr review $PR --approve --body "ğŸ‘ è‡ªåŠ¨äº’ç›¸ Code Review" --repo $REPO
          done
