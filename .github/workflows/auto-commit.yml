name: Daily GitHub Activity

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹è§¦å‘
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  daily-activity:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_PAT }} # åœ¨ Secrets é‡Œè®¾ç½® GH_PAT

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Setup GitHub CLI
        uses: cli/gh-actions@v2

      # éšæœºå»¶è¿Ÿ 0~3 å°æ—¶
      - name: Random delay
        run: |
          DELAY=$((RANDOM % 1))
          echo "ç­‰å¾… $DELAY ç§’å†æ‰§è¡Œ..."
          sleep $DELAY

      - name: Ensure logs directory
        run: mkdir -p logs

      - name: Clean up old logs
        run: |
          find logs -type f -mtime +7 -exec rm -f {} \;
          echo "æ¸…ç†å®Œ 7 å¤©å‰æ—¥å¿—"

      - name: Append daily log
        run: |
          LOG_FILE="logs/$(TZ='Asia/Shanghai' date '+%Y-%m-%d').md"
          echo "$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨æäº¤æ—¥å¿— ðŸŒ±" >> "$LOG_FILE"

      - name: Commit and push log
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add logs/
          git commit -m "chore: daily log update" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push origin main || echo "push failed (maybe no permission)"

      - name: Randomly create Issue
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 30 ]; then
            echo "ç”Ÿæˆæ¯æ—¥ Issue"
            gh issue create --title "Daily Issue - $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" \
                            --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ðŸŒ±" \
                            --repo $GITHUB_REPOSITORY
          fi

      - name: Randomly create PR
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 30 ]; then
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b $BRANCH
            echo "$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨ PR æ—¥å¿— ðŸŒ±" >> logs/$(TZ='Asia/Shanghai' date '+%Y-%m-%d').md
            git add logs/
            git commit -m "chore: daily PR update"
            git push origin $BRANCH
            gh pr create --title "Daily PR - $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" \
                         --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ðŸŒ±" \
                         --base main \
                         --head $BRANCH \
                         --repo $GITHUB_REPOSITORY
          fi

      - name: Auto Review and Merge Personal PR
        run: |
          TARGET_REPO="${GITHUB_REPOSITORY}"
          PR_LIST=$(gh pr list --state open --repo "$TARGET_REPO" --json number -q '.[].number')
          if [ -z "$PR_LIST" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°å¯ review çš„ PR"
            exit 0
          fi
          PR_NUM=$(echo "$PR_LIST" | shuf -n1)
          echo "å‡†å¤‡å¯¹ PR #$PR_NUM è¿›è¡Œè‡ªåŠ¨ Review"
          gh pr review "$PR_NUM" --approve --body "ðŸ¤– è‡ªåŠ¨å®¡æŸ¥é€šè¿‡"
          gh pr merge "$PR_NUM" --squash --delete-branch --repo "$TARGET_REPO" --admin

      - name: Clean up old merged branches
        run: |
          TARGET_REPO="${GITHUB_REPOSITORY}"
          echo "å¼€å§‹æ¸…ç† 7 å¤©å‰å·²åˆå¹¶çš„åˆ†æ”¯..."
          git fetch --prune
          for branch in $(gh api repos/$TARGET_REPO/branches --paginate --jq '.[].name' | grep '^daily-pr-' || true); do
            if git branch -r --contains origin/$branch | grep -q "origin/main"; then
              LAST_COMMIT=$(gh api repos/$TARGET_REPO/commits/$branch --jq '.commit.committer.date' || echo "")
              if [ -z "$LAST_COMMIT" ]; then
                continue
              fi
              LAST_COMMIT_TS=$(date -d "$LAST_COMMIT" +%s)
              NOW=$(date +%s)
              AGE=$(( (NOW - LAST_COMMIT_TS) / 86400 ))
              if [ $AGE -gt 7 ]; then
                echo "åˆ é™¤å·²åˆå¹¶å¹¶è¶…è¿‡ 7 å¤©çš„åˆ†æ”¯: $branch"
                git push origin --delete $branch || true
              fi
            fi
          done

      - name: Star and fork trending repositories (with log)
        run: |
          LOG_FILE="logs/star_fork.log"
          echo "===== $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') =====" >> "$LOG_FILE"
          echo "èŽ·å–çƒ­é—¨ä»“åº“..." >> "$LOG_FILE"

          REPOS=$(gh api 'search/repositories?q=stars:>5000&sort=stars&order=desc&per_page=10' --jq '.items[].full_name' || true)

          if [ -z "$REPOS" ]; then
            echo "æœªèƒ½èŽ·å–åˆ°ä»“åº“åˆ—è¡¨ï¼Œç»“æŸã€‚" >> "$LOG_FILE"
            exit 0
          fi

          COUNT=0
          for repo in $REPOS; do
            RAND=$((RANDOM % 100))
            if [ $RAND -lt 100 ]; then
              echo "â­ ä¸ºä»“åº“åŠ æ˜Ÿ: $repo"
              gh api --method PUT "user/starred/$repo" || echo "åŠ æ˜Ÿå¤±è´¥: $repo"
              echo "$(TZ='Asia/Shanghai' date '+%H:%M:%S') - â­ åŠ æ˜Ÿ: $repo" >> "$LOG_FILE"

              echo "ðŸ´ Fork ä»“åº“: $repo"
              gh repo fork "$repo" --clone=false --remote=false || echo "Fork å¤±è´¥: $repo"
              echo "$(TZ='Asia/Shanghai' date '+%H:%M:%S') - ðŸ´ Fork: $repo" >> "$LOG_FILE"

              COUNT=$((COUNT+1))
              sleep $((RANDOM % 5))
              if [ $COUNT -ge 1 ]; then
                echo "å·²åŠ æ˜Ÿå¹¶ fork 1 ä¸ªä»“åº“ï¼Œåœæ­¢ã€‚" >> "$LOG_FILE"
                break
              fi
            fi
          done
