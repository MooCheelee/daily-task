name: Daily Random GitHub Activity

on:
  schedule:
    - cron: '0 0 * * *'   # æ¯å¤© UTC 0ç‚¹è§¦å‘
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      # æ‹‰å–ä»“åº“
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}

      # éšæœºå»¶è¿Ÿï¼ˆ0~24å°æ—¶å†…éšæœºæ—¶é—´æ‰§è¡Œï¼‰
      - name: Wait for random delay
        run: |
          DELAY=$((RANDOM % 1))
          echo "Waiting $DELAY seconds..."
          sleep $DELAY

      # ç¡®ä¿ update.md æ–‡ä»¶å­˜åœ¨
      - name: Ensure update.md exists
        run: |
          if [ ! -f update.md ]; then
            echo "# ðŸ“… Daily GitHub Activity Log" > update.md
            echo "" >> update.md
          fi

      # éšæœºæäº¤æ—¥å¿—
      - name: Append random log
        run: |
          echo "## $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" >> update.md
          echo "- ðŸ“ Commit: è‡ªåŠ¨æäº¤æ—¥å¿— ðŸŒ±" >> update.md
          echo "" >> update.md

      - name: Commit and push log
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add update.md
          git commit -m "chore: daily log update" || echo "No changes"
          git push origin HEAD:main

      # éšæœº Issue (30%)
      - name: Random Issue
        run: |
          RAND=$((RANDOM % 100))
          DAY=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          if [ $RAND -lt 100 ]; then
            ISSUE_URL=$(gh issue create \
                        --title "Daily Issue - $DAY" \
                        --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ðŸŒ±" \
                        --repo $GITHUB_REPOSITORY | tail -n 1)
            echo "- ðŸ› Issue: $ISSUE_URL" >> update.md
          else
            echo "- ðŸ› Issue: æ— " >> update.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      # éšæœº PR (30%)
      - name: Random PR
        run: |
          RAND=$((RANDOM % 100))
          DAY=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          if [ $RAND -lt 100 ]; then
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b $BRANCH
            echo "- ðŸ”€ PR Commit: è‡ªåŠ¨ PR æ—¥å¿— ðŸŒ±" >> update.md
            git add update.md
            git commit -m "chore: daily PR update"
            git push origin $BRANCH
            PR_URL=$(gh pr create \
                      --title "Daily PR - $DAY" \
                      --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ðŸŒ±" \
                      --base main --head $BRANCH \
                      --repo $GITHUB_REPOSITORY | tail -n 1)
            echo "- ðŸ”€ PR: $PR_URL" >> update.md
          else
            echo "- ðŸ”€ PR: æ— " >> update.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      # éšæœº Code Review (30%)
      - name: Random Review
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 100 ]; then
            PR_URL=$(gh pr list --state open --repo $GITHUB_REPOSITORY | head -n 1 | awk '{print $1}')
            if [ -n "$PR_URL" ]; then
              echo "Reviewing PR #$PR_URL"
              gh pr review $PR_URL --approve --body "LGTM ðŸ‘ è‡ªåŠ¨å®¡æ ¸"
              echo "- ðŸ‘€ Review: å·²å®¡æ ¸ PR #$PR_URL" >> update.md
            else
              echo "- ðŸ‘€ Review: æ— å¯ç”¨ PR" >> update.md
            fi
          else
            echo "- ðŸ‘€ Review: æœªæ‰§è¡Œ" >> update.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      # æ›´æ–° update.md (æŠŠ Issue/PR/Review å†™è¿›åŽ»)
      - name: Final Commit
        run: |
          git add update.md
          git commit -m "chore: update daily log (issues/pr/reviews)" || echo "No changes"
          git push origin HEAD:main
