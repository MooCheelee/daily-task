name: Daily GitHub Activity

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹è§¦å‘
  workflow_dispatch:
  pull_request:
    paths:
      - "update.md"

jobs:
  daily-activity:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Random delay (0~24h)
        run: |
          DELAY=$((RANDOM % 1))
          echo "ç­‰å¾… $DELAY ç§’å†æ‰§è¡Œ..."
          sleep $DELAY

      - name: Ensure update.md exists
        run: |
          if [ ! -f update.md ]; then
            echo "# Daily Commit Log" > update.md
          fi

      - name: Clean up logs older than 7 days
        run: |
          find . -name "update.md" -mtime +7 -exec rm -f {} \;
          echo "æ¸…ç†å®Œ 7 å¤©å‰æ—¥å¿—"

      - name: Append daily log
        run: |
          echo "$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨æäº¤æ—¥å¿— ğŸŒ±" >> update.md

      - name: Commit and push log
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add update.md
          git commit -m "chore: daily log update" || echo "No changes to commit"
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:main

      - name: Randomly create Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 100 ]; then  # 30% æ¦‚ç‡
            gh issue create --title "Daily Issue - $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" \
                            --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ğŸŒ±" \
                            --repo $GITHUB_REPOSITORY

      - name: Randomly create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 100 ]; then
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b $BRANCH
            echo "$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨ PR æ—¥å¿— ğŸŒ±" >> update.md
            git add update.md
            git commit -m "chore: daily PR update"
            git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:$BRANCH
            gh pr create --title "Daily PR - $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" \
                         --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ğŸŒ±" \
                         --base main \
                         --head $BRANCH \
                         --repo $GITHUB_REPOSITORY

      - name: Auto Code Review on external repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TARGET_REPO="MooChee-lee/Daily-Quests"
          PR_LIST=$(gh pr list --state open --repo "$TARGET_REPO" --json number -q '.[].number')
          if [ -z "$PR_LIST" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°å¯ review çš„ PR"
            exit 0
          fi
          PR_NUM=$(echo "$PR_LIST" | shuf -n1)
          echo "å‡†å¤‡å¯¹ PR #$PR_NUM è¿›è¡Œè‡ªåŠ¨ Review"
          gh pr review "$PR_NUM" --approve --body "ğŸ¤– è‡ªåŠ¨ Review: çœ‹èµ·æ¥ä¸é”™ï¼" --repo "$TARGET_REPO"

  auto-resolve:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Merge target branch into PR branch
        run: |
          git fetch origin ${{ github.base_ref }}
          git merge origin/${{ github.base_ref }} --no-commit || true

      - name: Auto merge update.md (keep order + prepend log)
        run: |
          if git diff --name-only --diff-filter=U | grep -q "update.md"; then
            echo "âš¡ æ£€æµ‹åˆ° update.md å†²çªï¼Œè‡ªåŠ¨åˆå¹¶å¹¶è®°å½•æ—¥å¿—..."
            awk '/^<<<<<<< / {side=1; next} /^=======/ {side=2; next} /^>>>>>>> / {side=0; next} side==1 {print > "side1.txt"} side==2 {print > "side2.txt"}' update.md
            cat side1.txt side2.txt | awk '!seen[$0]++' > update.md.merged
            echo "ğŸ¤– Auto-resolved conflict at $(date '+%Y-%m-%d %H:%M:%S') (commit: $(git rev-parse --short HEAD))" | cat - update.md.merged > update.md
            rm -f side1.txt side2.txt update.md.merged
            git add update.md
            git commit -m "chore: auto-merge conflict in update.md (keep order + prepend log)"
          fi

      - name: Push changes
        run: git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:${{ github.head_ref }}

      - name: Comment on PR
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "ğŸ¤– æˆ‘æ£€æµ‹åˆ° **update.md** å­˜åœ¨å†²çªï¼Œå¹¶å·²è‡ªåŠ¨è§£å†³ã€‚\næ—¥å¿—å·²æ›´æ–°ï¼Œå¹¶åœ¨æ–‡ä»¶å¼€å¤´æ’å…¥äº†è§£å†³æ—¶é—´å’Œ commit SHAã€‚" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
