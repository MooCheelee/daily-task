name: Daily GitHub Activity

on:
  schedule:
    - cron: '0 0 * * *'   # æ¯å¤© UTC 0 ç‚¹è§¦å‘
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Run random actions
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set -e
          LOG_FILE="update.md"
          [ ! -f "$LOG_FILE" ] && echo "# Daily Commit Log" > "$LOG_FILE"

          COUNT=$(( (RANDOM % 5) + 2 )) # 2~6 æ¬¡
          echo "ä»Šå¤©æ‰§è¡Œ $COUNT æ¬¡ä»»åŠ¡"

          for i in $(seq 1 $COUNT); do
            ACTION_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            WAIT=$((RANDOM % 1800))  # 0~30 åˆ†é’Ÿ
            echo "ç¬¬ $i æ¬¡ä»»åŠ¡ï¼Œç­‰å¾… $WAIT ç§’..."
            sleep $WAIT

            # å‘¨æœ« 30% æ‘¸é±¼
            DOW=$(date +%u)
            if [[ "$DOW" -ge 6 && $((RANDOM % 100)) -lt 30 ]]; then
              echo "[$ACTION_TIME] ğŸ’¤ å‘¨æœ«æ‘¸é±¼ï¼Œè·³è¿‡ä»»åŠ¡" >> "$LOG_FILE"
              continue
            fi

            case $((RANDOM % 5)) in
              0) # Commit æ—¥å¿—
                git config user.name "github-actions[bot]"
                git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                echo "[$ACTION_TIME] - è‡ªåŠ¨æäº¤æ—¥å¿— ğŸŒ±" >> "$LOG_FILE"
                git add "$LOG_FILE"
                git commit -m "chore: daily log update" || true
                git push origin main || true
                echo "[$ACTION_TIME] ğŸ“ æäº¤æ—¥å¿—" >> "$LOG_FILE"
                ;;

              1) # åˆ›å»º Issue
                ISSUE_URL=$(gh issue create \
                  --title "Daily Issue - $(date '+%Y-%m-%d')" \
                  --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ğŸŒ±" \
                  --repo "$GITHUB_REPOSITORY")
                echo "[$ACTION_TIME] ğŸ› åˆ›å»º Issue $ISSUE_URL" >> "$LOG_FILE"
                ;;

              2) # åˆ›å»º PR
                BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
                git checkout -b "$BRANCH"
                git config user.name "github-actions[bot]"
                git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                echo "[$ACTION_TIME] - è‡ªåŠ¨ PR æ—¥å¿— ğŸŒ±" >> "$LOG_FILE"
                git add "$LOG_FILE"
                git commit -m "chore: daily PR update"
                git push origin "$BRANCH"
                PR_URL=$(gh pr create \
                  --title "Daily PR - $(date '+%Y-%m-%d')" \
                  --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ğŸŒ±" \
                  --base main \
                  --head "$BRANCH" \
                  --repo "$GITHUB_REPOSITORY")
                echo "[$ACTION_TIME] ğŸ”€ åˆ›å»º PR $PR_URL" >> "$LOG_FILE"
                ;;

              3) # å®¡æŸ¥å¹¶åˆå¹¶ PR
                PR_NUM=$(gh pr list --state open --repo "$GITHUB_REPOSITORY" --json number --jq '.[0].number')
                if [ -n "$PR_NUM" ]; then
                  gh pr review "$PR_NUM" --comment --body "ğŸ¤– è‡ªåŠ¨å®¡æŸ¥ï¼ˆè‡ªä»“åº“æ— éœ€ approveï¼‰"
                  sleep 20
                  MERGEABLE=$(gh pr view "$PR_NUM" --repo "$GITHUB_REPOSITORY" --json mergeable --jq '.mergeable')
                  if [ "$MERGEABLE" = "MERGEABLE" ]; then
                    gh pr merge "$PR_NUM" --squash --delete-branch --repo "$GITHUB_REPOSITORY" --admin
                    echo "[$ACTION_TIME] ğŸ” è‡ªåŠ¨å®¡æŸ¥å¹¶åˆå¹¶ PR #$PR_NUM" >> "$LOG_FILE"
                  else
                    echo "[$ACTION_TIME] âš ï¸ PR #$PR_NUM æš‚ä¸å¯åˆå¹¶" >> "$LOG_FILE"
                  fi
                else
                  echo "[$ACTION_TIME] âŒ æ²¡æœ‰æ‰¾åˆ°å¯å®¡æŸ¥çš„ PR" >> "$LOG_FILE"
                fi
                ;;

              4) # Star ä»“åº“
                REPOS=$(gh api 'search/repositories?q=stars:>5000&sort=stars&order=desc&per_page=20' --jq '.items[].full_name')
                COUNT_STAR=0
                for repo in $REPOS; do
                  gh api --method PUT "user/starred/$repo" || true
                  echo "[$ACTION_TIME] â­ Star ä»“åº“: $repo" >> "$LOG_FILE"
                  COUNT_STAR=$((COUNT_STAR+1))
                  if [ $COUNT_STAR -ge 2 ]; then break; fi
                done
                ;;
            esac
          done

      - name: Clean up old logs (15 days)
        run: |
          find . -name "update.md" -mtime +15 -exec rm -f {} \; || true
          echo "ğŸ§¹ å·²æ¸…ç† 15 å¤©å‰çš„æ—¥å¿—"

      - name: Clean up merged branches (15 days)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TARGET_REPO="${GITHUB_REPOSITORY}"
          echo "å¼€å§‹æ¸…ç†å·²åˆå¹¶ 15 å¤©å‰çš„åˆ†æ”¯..."
          for branch in $(gh api repos/$TARGET_REPO/branches --paginate --jq '.[].name' | grep '^daily-pr-'); do
            if git branch -r --contains origin/$branch | grep -q "origin/main"; then
              LAST_COMMIT=$(gh api repos/$TARGET_REPO/commits/$branch --jq '.commit.committer.date')
              LAST_COMMIT_TS=$(date -d "$LAST_COMMIT" +%s)
              NOW=$(date +%s)
              AGE=$(( (NOW - LAST_COMMIT_TS) / 86400 ))
              if [ $AGE -gt 15 ]; then
                echo "åˆ é™¤å·²åˆå¹¶å¹¶è¶…è¿‡ 15 å¤©çš„åˆ†æ”¯: $branch"
                git push origin --delete "$branch" || true
              fi
            fi
          done
