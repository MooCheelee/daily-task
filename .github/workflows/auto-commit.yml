name: Test Code Review Activity

on:
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      # æ‹‰å–ä»“åº“
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}

      # ----- éšæœºç»™ PR è¿›è¡Œä»£ç å®¡æŸ¥ (30% æ¦‚ç‡) (å¢åŠ  Code Reviews) -----
      - name: Randomly add code review comment
        run: |
          RAND=$((RANDOM % 100))
          if [ $RAND -lt 30 ]; then
            # è·å–ç¬¬ä¸€ä¸ªæ‰“å¼€çš„ PR URL å’Œ PR ä½œè€…
            PR_INFO=$(gh pr list --state open --repo $GITHUB_REPOSITORY --json url,author -q '.[0]')
            PR_URL=$(echo "$PR_INFO" | jq -r '.url')
            PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.author.login')

            # è·å–å½“å‰ GitHub ç”¨æˆ·å
            CURRENT_USER=$(gh api user -q '.login')

            # æ£€æŸ¥ PR ä½œè€…æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·
            if [ "$PR_AUTHOR" != "$CURRENT_USER" ]; then
              if [ -n "$PR_URL" ]; then
                echo "Adding review comment to PR: $PR_URL"
                gh pr review $PR_URL --approve --body "Good work! Keep it up! ğŸŒ±"
              else
                echo "No open PR found to review."
              fi
            else
              echo "Skipping review for your own PR."
            fi
          else
            echo "ä»Šå¤©ä¸è¿›è¡Œä»£ç å®¡æŸ¥"
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
