name: Daily GitHub Activity


on:
  schedule:
    - cron: '0 00 * * *'  # UTC # æ¯å¤© UTC 0 ç‚¹è§¦å‘
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      # æ‹‰å–ä»“åº“
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      # å‘¨æœ«æ‡’æƒ°æ¨¡å¼åˆ¤æ–­
      - name: Weekend lazy check
        id: lazy
        run: |
          DOW=$(date +%u)  # 1=Mon ... 7=Sun
          if [ $DOW -gt 5 ] && [ $((RANDOM % 100)) -lt 40 ]; then
            echo "lazy=true" >> $GITHUB_OUTPUT
            echo "ä»Šå¤©å‘¨æœ«ï¼Œé€‰æ‹©æ‘¸é±¼ âœ¨"
            echo "ä»Šå¤©å‘¨æœ«ï¼Œé€‰æ‹©æ‘¸é±¼ âœ¨" >> update.md
          else
            echo "lazy=false" >> $GITHUB_OUTPUT
          fi
    
      # éšæœºå»¶è¿Ÿ 0~6 å°æ—¶
      - name: Random delay
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          DELAY=$((RANDOM % 21600))
          echo "ç­‰å¾… $DELAY ç§’å†æ‰§è¡Œ..."
          sleep $DELAY

      # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
      - name: Ensure update.md exists
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          if [ ! -f update.md ]; then
            echo "# Daily Commit Log" > update.md
          fi

      # å¼€åœºç™½
      - name: Write daily intro
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          LOG_DATE=$(date '+%Y-%m-%d')
          echo -e "\n## $LOG_DATE" >> update.md
          MOODS=("âœ¨ å¼€å§‹ä»Šå¤©çš„ Github å†’é™©ï¼" "â˜• è¾¹å–å’–å•¡è¾¹å†™ç‚¹ä»£ç ï½ž" "ðŸ› ï¸ ä»Šå¤©ä¹Ÿè¦æŠ˜è…¾ä¸€ç•ªï¼" "ðŸ“– è®°å½•ä¸€ä¸‹æ—¥å¸¸æ“ä½œ")
          echo "${MOODS[$RANDOM % ${#MOODS[@]}]}" >> update.md

      # æ—¥å¸¸æ—¥å¿—
      - name: Append random logs
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          LOG_FILE="update.md"
          for i in $(seq 1 $((RANDOM % 3 + 1))); do
            NOW=$(date '+%H:%M:%S')
            THOUGHTS=("ðŸŒ± éšæ‰‹è®°ä¸‹ä¸€ç¬”" "âœï¸ çªç„¶æƒ³åˆ°ç‚¹ä¸œè¥¿" "ðŸš€ æ¥ä¸€å‘ PR" "ðŸ“Œ æ‰“ä¸ªå°è¡¥ä¸" "ðŸŽ¯ è¯•è¯•æ–°ç‚¹å­")
            echo "[$NOW] ${THOUGHTS[$RANDOM % ${#THOUGHTS[@]}]}" >> $LOG_FILE
          done

      # æäº¤æ—¥å¿—
      - name: Commit and push log
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A
          git stash push --include-untracked -m "auto-stash"
          git pull --rebase origin main || git rebase --abort
          git stash pop || true

          git commit -m "chore: daily log update" || echo "No changes"
          git push origin HEAD:main

      # åˆ›å»º Issue æˆ– PR
      - name: Create Issue or PR
        if: steps.lazy.outputs.lazy != 'true'
        id: issuepr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          CREATED="false"
          if [ $((RANDOM % 2)) -eq 0 ]; then
            gh issue create --title "Daily Issue - $(date '+%Y-%m-%d')" \
                            --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ðŸŒ±" \
                            --repo $GITHUB_REPOSITORY
            CREATED="true"
          else
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b $BRANCH
            echo "$(date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨ PR æ—¥å¿— ðŸŒ±" >> update.md
            git add update.md
            git commit -m "chore: daily PR update"
            git push origin $BRANCH
            gh pr create --title "Daily PR - $(date '+%Y-%m-%d')" \
                         --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ðŸŒ±" \
                         --base main --head $BRANCH --repo $GITHUB_REPOSITORY
            CREATED="true"
          fi
          echo "created=$CREATED" >> $GITHUB_OUTPUT

      # è‡ªåŠ¨ Review + åˆå¹¶ PR
      - name: Auto Review and Merge
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TARGET_REPO="${GITHUB_REPOSITORY}"
          PR_LIST=$(gh pr list --state open --repo "$TARGET_REPO" --json number -q '.[].number')
          if [ -n "$PR_LIST" ]; then
            PR_NUM=$(echo "$PR_LIST" | shuf -n1)
            gh pr review "$PR_NUM" --comment --body "ðŸ¤– è‡ªåŠ¨å®¡æŸ¥ï¼šLGTMï¼"
            gh pr merge "$PR_NUM" --squash --delete-branch --repo "$TARGET_REPO" --admin
          fi

      # è‡ªåŠ¨ Star
      - name: Star random repos
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          STAR_COUNT=$((RANDOM % 2 + 1))
          echo "ä»Šå¤©è¦ç‚¹äº® $STAR_COUNT ä¸ªå°æ˜Ÿæ˜Ÿ â­"
          repos=$(gh api search/repositories -X GET -F q='stars:>50000 sort:stars' --jq '.items[].full_name' | shuf -n $STAR_COUNT)
          for repo in $repos; do
            gh api --method PUT "user/starred/$repo"
            echo "â­ Starred $repo" >> update.md
          done

      # æ¸…ç†å·²åˆå¹¶ 7 å¤©å‰çš„åˆ†æ”¯
      - name: Clean up old merged branches
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          TARGET_REPO="${GITHUB_REPOSITORY}"
          NOW=$(date +%s)
          gh pr list --state merged --repo "$TARGET_REPO" --json number,headRefName,mergergedAt -q '.[]' | while read pr; do
            PR_NUM=$(echo "$pr" | jq -r '.number')
            BRANCH=$(echo "$pr" | jq -r '.headRefName')
            MERGED_AT=$(echo "$pr" | jq -r '.mergedAt')
            MERGED_TS=$(date -u -d "$MERGED_AT" +%s)
            AGE=$(( (NOW - MERGED_TS) / 86400 ))
            if [[ "$BRANCH" == daily-pr-* && $AGE -gt 7 ]]; then
              echo "ðŸ—‘ï¸ åˆ é™¤å·²åˆå¹¶è¶…è¿‡ 7 å¤©çš„åˆ†æ”¯: $BRANCH (PR #$PR_NUM)"
              git push origin --delete "$BRANCH" || true
            fi
          done

      # æ—¥ç»ˆæ€»ç»“
      - name: Write summary
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          git add -A
          git stash push --include-untracked -m "auto-stash"
          git pull --rebase origin main || git rebase --abort
          git stash pop || true

          echo "ðŸŒ™ ä»Šæ—¥å°ç»“ï¼šå®Œæˆäº†ä¸€äº›æäº¤/Issue/PR/Star â­" >> update.md
          git add update.md
          git commit -m "chore: daily summary" || echo "No changes"
          git push origin HEAD:main
