name: Daily GitHub Activity

env:
  TZ: Asia/Shanghai  # å…¨å±€åŒ—äº¬æ—¶é—´

on:
  schedule:
    - cron: '0 00 * * *'  # UTC # æ¯å¤© UTC 0 ç‚¹è§¦å‘
  workflow_dispatch:

jobs:
  daily-activity:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      # 2. Weekend lazy check
      - name: Weekend lazy check
        id: lazy
        run: |
          #!/bin/bash
          DOW=$(date +%u)
          if [ "$DOW" -gt 5 ] && [ $((RANDOM % 100)) -lt 30 ]; then     #å‘¨æœ«30%æ¦‚ç‡æ‘¸é±¼
            echo "lazy=true" >> $GITHUB_OUTPUT
            echo "ä»Šå¤©å‘¨æœ«ï¼Œé€‰æ‹©æ‘¸é±¼ âœ¨" >> update.md
          else
            echo "lazy=false" >> $GITHUB_OUTPUT
          fi

      # 3. Random delay
      - name: Random delay
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          #!/bin/bash
          DELAY=$((RANDOM % 2))     #éšæœºå»¶è¿Ÿ0~6å°æ—¶
          sleep $DELAY

      # 4. Ensure update.md exists
      - name: Ensure update.md exists
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          #!/bin/bash
          [ -f update.md ] || echo "# Daily Commit Log" > update.md

      # 5. Write daily intro
      - name: Write daily intro
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          #!/bin/bash
          LOG_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          echo -e "\n## $LOG_DATE" >> update.md
          MOODS=("âœ¨ å¼€å§‹ä»Šå¤©çš„ Github å†’é™©ï¼" "â˜• è¾¹å–å’–å•¡è¾¹å†™ç‚¹ä»£ç ï½" "ğŸ› ï¸ ä»Šå¤©ä¹Ÿè¦æŠ˜è…¾ä¸€ç•ªï¼" "ğŸ“– è®°å½•ä¸€ä¸‹æ—¥å¸¸æ“ä½œ")
          echo "${MOODS[$RANDOM % ${#MOODS[@]}]}" >> update.md

      # 6. Append random logs
      - name: Append random logs
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          #!/bin/bash
          LOG_FILE="update.md"
          for i in $(seq 1 $((RANDOM % 3 + 1))); do
            NOW=$(date '+%H:%M:%S')
            THOUGHTS=("ğŸŒ± éšæ‰‹è®°ä¸‹ä¸€ç¬”" "âœï¸ çªç„¶æƒ³åˆ°ç‚¹ä¸œè¥¿" "ğŸš€ æ¥ä¸€å‘ PR" "ğŸ“Œ æ‰“ä¸ªå°è¡¥ä¸" "ğŸ¯ è¯•è¯•æ–°ç‚¹å­")
            echo "[$NOW] ${THOUGHTS[$RANDOM % ${#THOUGHTS[@]}]}" >> "$LOG_FILE"
          done

      # 7. Commit & push log
      - name: Commit and push log
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          #!/bin/bash
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add update.md
          git commit -m "chore: daily log update" || echo "No changes"

          git fetch origin main
          git rebase origin/main || git rebase --abort
          git push origin HEAD:main || git push --force-with-lease origin HEAD:main

      # 8. Clean logs older than 7 days
      - name: Clean logs older than 7 days
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          #!/bin/bash
          FILE="update.md"
          if [ -f "$FILE" ]; then
            SEVEN_DAYS_AGO=$(date -d '7 days ago' '+%Y-%m-%d')
            awk -v d="$SEVEN_DAYS_AGO" '/^## / {date=$2} date >= d {print}' "$FILE" > "$FILE.tmp"
            mv "$FILE.tmp" "$FILE"

            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add "$FILE"
            git commit -m "chore: clean logs older than 7 days" || echo "No changes"

            git fetch origin main
            git rebase origin/main || git rebase --abort
            git push origin HEAD:main || git push --force-with-lease origin HEAD:main
          fi

      # 9. Create Issue or PR (æ¦‚ç‡æ§åˆ¶)
      - name: Create Issue or PR
        if: steps.lazy.outputs.lazy != 'true'
        id: issuepr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          #!/bin/bash
          CREATED_ISSUE=0
          CREATED_PR=0
          PROB_ISSUE=30   #30%åˆ›å»ºIssue
          PROB_PR=40      # 40%åˆ›å»º PR
          RAND=$(( RANDOM % 100 + 1 ))

          if [ $RAND -le $PROB_ISSUE ]; then
            gh issue create --title "Daily Issue - $(date '+%Y-%m-%d %H:%M:%S')" \
                            --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ğŸŒ±" \
                            --repo $GITHUB_REPOSITORY
            CREATED_ISSUE=1
          elif [ $RAND -le $((PROB_ISSUE + PROB_PR)) ]; then
            BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
            git checkout -b "$BRANCH"
            echo "$(date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨ PR æ—¥å¿— ğŸŒ±" >> update.md
            git add update.md
            git commit -m "chore: daily PR update"
            git push origin "$BRANCH"
            gh pr create --title "Daily PR - $(date '+%Y-%m-%d %H:%M:%S')" \
                         --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ğŸŒ±" \
                         --base main --head "$BRANCH" --repo $GITHUB_REPOSITORY
            CREATED_PR=1
          else
            echo "ä»Šå¤©ä¸åˆ›å»º Issue æˆ– PR ğŸŒ±"
          fi

          echo "CREATED_ISSUE=$CREATED_ISSUE" >> $GITHUB_OUTPUT
          echo "CREATED_PR=$CREATED_PR" >> $GITHUB_OUTPUT

      # 10. Auto Review & Merge PR
      - name: Auto Review and Merge
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          #!/bin/bash
          TARGET_REPO="${GITHUB_REPOSITORY}"
          PR_LIST=$(gh pr list --state open --repo "$TARGET_REPO" --json number -q '.[].number')
          if [ -n "$PR_LIST" ]; then
            PR_NUM=$(echo "$PR_LIST" | shuf -n1)
            gh pr review "$PR_NUM" --comment --body "ğŸ¤– è‡ªåŠ¨å®¡æŸ¥ï¼šLGTMï¼"
            gh pr merge "$PR_NUM" --squash --delete-branch --repo "$TARGET_REPO" --admin
          fi

      # 11. Star and Fork random repos
      - name: Star and Fork random repos
        if: steps.lazy.outputs.lazy != 'true'
        id: starfork
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          #!/bin/bash
          STAR_COUNT=0
          FORK_COUNT=0
          PROB_ACTION=30     #30%å‡ ç‡æ‰§è¡ŒStar + Fork
          RAND=$(( RANDOM % 100 + 1 ))

          if [ $RAND -le $PROB_ACTION ]; then
            ACTION_COUNT=$((RANDOM % 2 + 1))
            repos=$(gh api search/repositories -X GET -F q='stars:>50000 sort:stars' --jq '.items[].full_name' | shuf -n $ACTION_COUNT)

            for repo in $repos; do
              gh api --method PUT "user/starred/$repo"
              echo "â­ Starred $repo" >> update.md
              STAR_COUNT=$((STAR_COUNT+1))

              gh repo fork "$repo" --clone=false
              echo "ğŸ´ Forked $repo" >> update.md
              FORK_COUNT=$((FORK_COUNT+1))
            done

            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add update.md
            git commit -m "chore: daily Star & Fork update" || echo "No changes"

            git fetch origin main
            git rebase origin/main || git rebase --abort
            git push origin HEAD:main || git push --force-with-lease origin HEAD:
          else
            echo "ä»Šå¤©ä¸è¿›è¡Œ Star/Fork ğŸŒ±" >> update.md
          fi

          echo "STAR_COUNT=$STAR_COUNT" >> $GITHUB_OUTPUT
          echo "FORK_COUNT=$FORK_COUNT" >> $GITHUB_OUTPUT

      # 12. Clean up old merged branches
      - name: Clean up old merged branches
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          #!/bin/bash
          TARGET_REPO="${GITHUB_REPOSITORY}"
          NOW=$(date +%s)
          gh pr list --state merged --repo "$TARGET_REPO" --json number,headRefName,mergedAt -q '.[]' | while read pr; do
            PR_NUM=$(echo "$pr" | jq -r '.number')
            BRANCH=$(echo "$pr" | jq -r '.headRefName')
            MERGED_AT=$(echo "$pr" | jq -r '.mergedAt')
            MERGED_TS=$(date -u -d "$MERGED_AT" +%s)
            AGE=$(( (NOW - MERGED_TS) / 86400 ))
            if [[ "$BRANCH" == daily-pr-* && $AGE -gt 7 ]]; then
              echo "ğŸ—‘ï¸ åˆ é™¤å·²åˆå¹¶è¶…è¿‡ 7 å¤©çš„åˆ†æ”¯: $BRANCH (PR #$PR_NUM)"
              git push origin --delete "$BRANCH" || true
            fi
          done
      # 12. Clean up old merged branches
      - name: Clean up old merged branches
        if: steps.lazy.outputs.lazy != 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          #!/bin/bash
          TARGET_REPO="${GITHUB_REPOSITORY}"
          NOW=$(date +%s)
          gh pr list --state merged --repo "$TARGET_REPO" --json number,headRefName,mergedAt -q '.[]' | while read pr; do
            PR_NUM=$(echo "$pr" | jq -r '.number')
            BRANCH=$(echo "$pr" | jq -r '.headRefName')
            MERGED_AT=$(echo "$pr" | jq -r '.mergedAt')
            MERGED_TS=$(date -u -d "$MERGED_AT" +%s)
            AGE=$(( (NOW - MERGED_TS) / 86400 ))
            if [[ "$BRANCH" == daily-pr-* && $AGE -gt 7 ]]; then
              echo "ğŸ—‘ï¸ åˆ é™¤å·²åˆå¹¶è¶…è¿‡ 7 å¤©çš„åˆ†æ”¯: $BRANCH (PR #$PR_NUM)"
              git push origin --delete "$BRANCH" || true
            fi
          done

      # 13. Daily summary
      - name: Write summary
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          #!/bin/bash
          NOW=$(date +"%Y-%m-%d %H:%M:%S")
          LOG_FILE="update.md"

          # ç»Ÿè®¡æ•°é‡
          LOG_COUNT=$(grep -c 'ğŸŒ±' $LOG_FILE || echo 0)
          ISSUE_COUNT=$(grep -c 'ğŸ“ åˆ›å»ºäº†ä¸€ä¸ª Issue' $LOG_FILE || echo 0)
          PR_COUNT=$(grep -c 'ğŸ“¦ æäº¤äº†ä¸€ä¸ª PR' $LOG_FILE || echo 0)
          MERGED_COUNT=$(grep -c 'âœ… è‡ªåŠ¨åˆå¹¶äº† PR' $LOG_FILE || echo 0)
          STAR_COUNT=$(grep -c 'â­' $LOG_FILE || echo 0)
          FORK_COUNT=$(grep -c 'ğŸ´' $LOG_FILE || echo 0)
          CLEAN_LOG_COUNT=$(grep -c 'æ¸…ç†è¶…è¿‡ 7 å¤©çš„æ—§æ—¥å¿—' $LOG_FILE || echo 0)
          CLEAN_BRANCH_COUNT=$(grep -c 'ğŸ—‘ï¸ åˆ é™¤äº†å·²åˆå¹¶è¶…è¿‡ 7 å¤©çš„åˆ†æ”¯' $LOG_FILE || echo 0)

          echo -e "\n### ğŸŒ™ ä»Šæ—¥æ€»ç»“" >> $LOG_FILE
          echo "[$NOW] ä»Šæ—¥ä»»åŠ¡å®Œæˆ âœ…" >> $LOG_FILE
          echo "- ğŸ“ æ—¥å¿—æ¡ç›®: $LOG_COUNT" >> $LOG_FILE
          echo "- ğŸ”§ åˆ›å»º Issue: $ISSUE_COUNT" >> $LOG_FILE
          echo "- ğŸ“¦ åˆ›å»º PR: $PR_COUNT" >> $LOG_FILE
          echo "- âœ… åˆå¹¶ PR: $MERGED_COUNT" >> $LOG_FILE
          echo "- â­ Star: $STAR_COUNT" >> $LOG_FILE
          echo "- ğŸ´ Fork: $FORK_COUNT" >> $LOG_FILE
          echo "- ğŸ§¹ æ¸…ç†æ—¥å¿—: $CLEAN_LOG_COUNT" >> $LOG_FILE
          echo "- ğŸ§¹ æ¸…ç†åˆ†æ”¯: $CLEAN_BRANCH_COUNT" >> $LOG_FILE

          # æäº¤æ€»ç»“
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add $LOG_FILE
          git commit -m "chore: daily summary with counts" || echo "No changes"
          git push origin HEAD:main

      # æ›´æ–° README ç»Ÿè®¡è¡¨æ ¼
      - name: Update README stats
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          #!/bin/bash
          LOG_FILE="update.md"
          README_FILE="README.md"

          # è·å–ä»Šæ—¥å’Œæœ€è¿‘ 7 å¤©ç»Ÿè®¡
          TODAY=$(date "+%Y-%m-%d")
          LOG_COUNT=$(grep -c "ğŸŒ±" "$LOG_FILE" || echo 0)
          ISSUE_COUNT=$(grep -c "ğŸ“" "$LOG_FILE" || echo 0)
          PR_COUNT=$(grep -c "ğŸ“¦" "$LOG_FILE" || echo 0)
          MERGED_COUNT=$(grep -c "âœ…" "$LOG_FILE" || echo 0)
          STAR_COUNT=$(grep -c "â­" "$LOG_FILE" || echo 0)
          FORK_COUNT=$(grep -c "ğŸ´" "$LOG_FILE" || echo 0)
          CLEAN_LOG_COUNT=$(grep -c "âœ‚ï¸" "$LOG_FILE" || echo 0)
          CLEAN_BRANCH_COUNT=$(grep -c "ğŸ—‘ï¸" "$LOG_FILE" || echo 0)

          # æ›¿æ¢ README è¡¨æ ¼è¡Œ
          sed -i -E "s/(\| ğŸ“ æ—¥å¿—æ¡ç›® \| )[0-9]+ \| [0-9]+ \|/\1$LOG_COUNT \| $LOG_COUNT \|/" $README_FILE
          sed -i -E "s/(\| ğŸ”§ åˆ›å»º Issue \| )[0-9]+ \| [0-9]+ \|/\1$ISSUE_COUNT \| $ISSUE_COUNT \|/" $README_FILE
          sed -i -E "s/(\| ğŸ“¦ åˆ›å»º PR \| )[0-9]+ \| [0-9]+ \|/\1$PR_COUNT \| $PR_COUNT \|/" $README_FILE
          sed -i -E "s/(\| âœ… åˆå¹¶ PR \| )[0-9]+ \| [0-9]+ \|/\1$MERGED_COUNT \| $MERGED_COUNT \|/" $README_FILE
          sed -i -E "s/(\| â­ Star \| )[0-9]+ \| [0-9]+ \|/\1$STAR_COUNT \| $STAR_COUNT \|/" $README_FILE
          sed -i -E "s/(\| ğŸ´ Fork \| )[0-9]+ \| [0-9]+ \|/\1$FORK_COUNT \| $FORK_COUNT \|/" $README_FILE
          sed -i -E "s/(\| ğŸ§¹ æ¸…ç†æ—¥å¿— \| )[0-9]+ \| [0-9]+ \|/\1$CLEAN_LOG_COUNT \| $CLEAN_LOG_COUNT \|/" $README_FILE
          sed -i -E "s/(\| ğŸ§¹ æ¸…ç†åˆ†æ”¯ \| )[0-9]+ \| [0-9]+ \|/\1$CLEAN_BRANCH_COUNT \| $CLEAN_BRANCH_COUNT \|/" $README_FILE

          # æäº¤æ›´æ–°
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add $README_FILE
          git commit -m "chore: update README stats for $TODAY" || echo "No changes"
          git push origin HEAD:main
