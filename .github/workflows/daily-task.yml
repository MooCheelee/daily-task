name: Daily GitHub Activity

on:
  schedule:
    - cron: '0 0 * * *'   # æ¯å¤© UTC 0 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼‰
  workflow_dispatch:

env:
  # æ‡’æƒ°æ¨¡å¼æ¦‚çŽ‡ï¼ˆ0-100ï¼‰ï¼Œæ¯”å¦‚ 40 è¡¨ç¤º 40% æ¦‚çŽ‡
  LAZY_RATE: 30
  # æ‡’æƒ°æ¨¡å¼è§¦å‘æ¡ä»¶ï¼šweekend / everyday / custom
  LAZY_MODE: weekend
  # è‡ªå®šä¹‰æ‡’æƒ°æ—¥ï¼Œä»… LAZY_MODE=custom æ—¶ç”Ÿæ•ˆï¼Œ1=Mon ... 7=Sun
  LAZY_DAYS: "7"

jobs:
  daily:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Set timezone to Asia/Shanghai
        run: sudo timedatectl set-timezone Asia/Shanghai

      # ---------- å‘¨æœ«æ‡’æƒ°æ¨¡å¼ ----------
      - name: Lazy mode check
        id: lazy
        run: |
          DOW=$(date +%u)  # ä»Šå¤©æ˜ŸæœŸå‡ ï¼Œ1=Mon ... 7=Sun
          RATE=${{ env.LAZY_RATE }}
          MODE=${{ env.LAZY_MODE }}
          DAYS="${{ env.LAZY_DAYS }}"

          TRIGGER=false

          if [ "$MODE" = "weekend" ]; then
            if [ $DOW -gt 5 ]; then
              TRIGGER=true
            fi
          elif [ "$MODE" = "everyday" ]; then
            TRIGGER=true
          elif [ "$MODE" = "custom" ]; then
            for d in $DAYS; do
              if [ "$DOW" = "$d" ]; then
                TRIGGER=true
              fi
            done
          fi

          if $TRIGGER && [ $((RANDOM % 100)) -lt $RATE ]; then
            echo "lazy=true" >> $GITHUB_OUTPUT
            echo "ä»Šå¤©é€‰æ‹©æ‘¸é±¼ âœ¨" >> update.md
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add update.md
            git commit -m "chore: lazy day log" || echo "No changes"
            git pull --rebase origin main || true
            git push origin main
          else
            echo "lazy=false" >> $GITHUB_OUTPUT
          fi

      # ---------- éšæœºå¤šæ¬¡æ‰§è¡Œä»»åŠ¡ ----------
      - name: Random multiple runs
        if: steps.lazy.outputs.lazy != 'true'
        run: |
          COUNT=$((RANDOM % 4 + 2))   # æ¯å¤© 2~5 æ¬¡
          echo "ä»Šå¤©è¦æ‰§è¡Œ $COUNT æ¬¡ä»»åŠ¡"

          for i in $(seq 1 $COUNT); do
            DELAY=$((RANDOM % 60))   # æ¯æ¬¡å»¶è¿Ÿ 0~6 å°æ—¶
            echo "ç¬¬ $i æ¬¡ä»»åŠ¡å°†åœ¨å»¶è¿Ÿ $DELAY ç§’åŽæ‰§è¡Œ"
            sleep $DELAY

            echo ">>> å¼€å§‹ç¬¬ $i æ¬¡ä»»åŠ¡ <<<"

            # ---------- ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨ ----------
            if [ ! -f update.md ]; then
              echo "# Daily Commit Log" > update.md
            fi

            # ---------- å¼€åœºç™½ ----------
            LOG_DATE=$(date '+%Y-%m-%d')
            echo -e "\n## $LOG_DATE" >> update.md
            MOODS=("âœ¨ å¼€å§‹ä»Šå¤©çš„ Github å†’é™©ï¼" "â˜• è¾¹å–å’–å•¡è¾¹å†™ç‚¹ä»£ç ï½ž" "ðŸ› ï¸ ä»Šå¤©ä¹Ÿè¦æŠ˜è…¾ä¸€ç•ªï¼" "ðŸ“– è®°å½•ä¸€ä¸‹æ—¥å¸¸æ“ä½œ")
            echo "${MOODS[$RANDOM % ${#MOODS[@]}]}" >> update.md

            # ---------- æ—¥å¸¸æ—¥å¿— ----------
            for j in $(seq 1 $((RANDOM % 3 + 1))); do
              NOW=$(date '+%H:%M:%S')
              THOUGHTS=("ðŸŒ± éšæ‰‹è®°ä¸‹ä¸€ç¬”" "âœï¸ çªç„¶æƒ³åˆ°ç‚¹ä¸œè¥¿" "ðŸš€ æ¥ä¸€å‘ PR" "ðŸ“Œ æ‰“ä¸ªå°è¡¥ä¸" "ðŸŽ¯ è¯•è¯•æ–°ç‚¹å­")
              echo "[$NOW] ${THOUGHTS[$RANDOM % ${#THOUGHTS[@]}]}" >> update.md
            done

            # ---------- æäº¤æ—¥å¿— ----------
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add update.md
            git commit -m "chore: daily log update ($i/$COUNT)" || echo "No changes"
            git pull --rebase origin main || true
            git push origin main

            # ---------- åˆ›å»º Issue æˆ– PR ----------
            CREATED="false"
            if [ $((RANDOM % 2)) -eq 0 ]; then
              gh issue create --title "Daily Issue - $(date '+%Y-%m-%d')" \
                              --body "éšæœºç”Ÿæˆæ¯æ—¥ Issue ðŸŒ±" \
                              --repo $GITHUB_REPOSITORY
              CREATED="true"
            else
              BRANCH="daily-pr-$(date '+%Y%m%d%H%M%S')"
              git checkout -b $BRANCH
              echo "$(date '+%Y-%m-%d %H:%M:%S') - è‡ªåŠ¨ PR æ—¥å¿— ðŸŒ±" >> update.md
              git add update.md
              git commit -m "chore: daily PR update"
              git push origin $BRANCH
              gh pr create --title "Daily PR - $(date '+%Y-%m-%d')" \
                           --body "éšæœºç”Ÿæˆæ¯æ—¥ PR ðŸŒ±" \
                           --base main --head $BRANCH --repo $GITHUB_REPOSITORY
              CREATED="true"
            fi

            # ---------- è‡ªåŠ¨ Review + åˆå¹¶ PR ----------
            TARGET_REPO="${GITHUB_REPOSITORY}"
            PR_LIST=$(gh pr list --state open --repo "$TARGET_REPO" --json number -q '.[].number')
            if [ -n "$PR_LIST" ]; then
              PR_NUM=$(echo "$PR_LIST" | shuf -n1)
              gh pr review "$PR_NUM" --comment --body "ðŸ¤– è‡ªåŠ¨å®¡æŸ¥ï¼šLGTMï¼"
              gh pr merge "$PR_NUM" --squash --delete-branch --repo "$TARGET_REPO" --admin
            fi

            # ---------- è‡ªåŠ¨ Star ----------
            STAR_COUNT=$((RANDOM % 2 + 1))
            echo "ä»Šå¤©è¦ç‚¹äº® $STAR_COUNT ä¸ªå°æ˜Ÿæ˜Ÿ â­"
            repos=$(gh api search/repositories -X GET -F q='stars:>50000 sort:stars' --jq '.items[].full_name' | shuf -n $STAR_COUNT)
            for repo in $repos; do
              gh api --method PUT "user/starred/$repo"
              echo "â­ Starred $repo" >> update.md
            done

            # ---------- æ¸…ç†å·²åˆå¹¶ 7 å¤©å‰çš„åˆ†æ”¯ ----------
            NOW_TS=$(date +%s)
            gh pr list --state merged --repo "$TARGET_REPO" --json number,headRefName,mergedAt -q '.[]' | while read pr; do
              PR_NUM=$(echo "$pr" | jq -r '.number')
              BRANCH=$(echo "$pr" | jq -r '.headRefName')
              MERGED_AT=$(echo "$pr" | jq -r '.mergedAt')
              MERGED_TS=$(date -u -d "$MERGED_AT" +%s)
              AGE=$(( (NOW_TS - MERGED_TS) / 86400 ))
              if [[ "$BRANCH" == daily-pr-* && $AGE -gt 7 ]]; then
                echo "ðŸ—‘ï¸ åˆ é™¤å·²åˆå¹¶è¶…è¿‡ 7 å¤©çš„åˆ†æ”¯: $BRANCH (PR #$PR_NUM)"
                git push origin --delete "$BRANCH" || true
              fi
            done

            # ---------- æ—¥ç»ˆæ€»ç»“ï¼ˆåªåœ¨æœ€åŽä¸€æ¬¡å†™ï¼‰ ----------
            if [ $i -eq $COUNT ]; then
              echo "ðŸŒ™ ä»Šæ—¥å°ç»“ï¼šå®Œæˆäº†ä¸€äº›æäº¤/Issue/PR/Star â­" >> update.md
              git add update.md
              git commit -m "chore: daily summary" || echo "No changes"
              git pull --rebase origin main || true
              git push origin main
            fi
          done
