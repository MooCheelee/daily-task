name: Auto PR & Review

on:
  schedule:
    - cron: "0 0 * * *"   # æ¯å¤© UTC 2:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘

jobs:
  auto-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      # ========= è´¦å· A æäº¤æ—¥å¿— & åˆ›å»º PR =========
      - name: Commit daily log (Account A)
        run: |
          echo "æ›´æ–°æ—¥å¿— $(date)" >> update.md
          git config --global user.name "AccountA"
          git config --global user.email "AccountA@example.com"
          git checkout -b daily-pr-$(date +%Y%m%d%H%M%S)
          git add update.md
          git commit -m "chore: finalize daily log"
          git push origin HEAD

      - name: Create PR (Account A)
        env:
          GH_TOKEN: ${{ secrets.PAT_A }}
        run: |
          gh pr create \
            --title "Daily Log Update $(date +%Y-%m-%d)" \
            --body "è‡ªåŠ¨ç”Ÿæˆçš„æ—¥å¿—æ›´æ–° PR" \
            --base main \
            --head $(git branch --show-current) \
            --repo ${{ github.repository }}

      # ========= è´¦å· B å®¡æ ¸ PR =========
      - name: Auto Approve PRs using B
        run: |
          echo "Fetching open PRs not by B..."

          bash -c '
            GH_TOKEN=${{ secrets.PAT_B }}
            REPO="${{ github.repository }}"
            B_USER="MooChee-lee"   # âš ï¸ æ›¿æ¢æˆè´¦å· B çš„ GitHub ç”¨æˆ·å

            # è·å–æ‰€æœ‰å¯å®¡æ ¸ PR
            PR_LIST=$(gh pr list --state open --repo $REPO --json number,author \
                      --jq ".[] | select(.author.login != \"$B_USER\") | .number")

            echo "å¯å®¡æ ¸çš„ PR åˆ—è¡¨ï¼š$PR_LIST"

            if [ -z "$PR_LIST" ]; then
              echo "æ²¡æœ‰å¯å®¡æ ¸çš„ PRï¼Œè·³è¿‡ approve"
            else
              for PR in $PR_LIST; do
                echo "Approving PR #$PR with B..."
                GH_TOKEN=${{ secrets.PAT_B }} gh pr review $PR --approve \
                  --body "ğŸ‘ è‡ªåŠ¨äº’ç›¸ Code Review" --repo $REPO
              done
            fi
          '
